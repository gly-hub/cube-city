# 关卡系统与任务系统设计文档

## 📋 概述

本文档描述了 CubeCity 游戏中新增的**渐进式关卡系统**和**任务系统**的设计与实现。这两个系统旨在增加游戏的可玩性和目标感，减少用户流失。

---

## 🎯 设计目标

1. **渐进式解锁**：玩家从 16x16 的小地图开始，通过完成目标和任务逐步解锁更大的地图（24x24、32x32 等）
2. **任务驱动**：每个关卡都有对应的任务，完成任务是解锁下一关的必要条件
3. **指标要求**：除了任务，还需要满足城市指标要求（人口、金币、稳定度等）
4. **持续激励**：通过关卡奖励和任务奖励，持续激励玩家继续游戏

---

## 🏗️ 系统架构

### 1. 关卡系统 (Level System)

#### 1.1 关卡配置 (`src/constants/level-config.js`)

定义了 5 个关卡：

| 关卡 | 地图大小 | 关卡名称 | 解锁条件 |
|------|---------|---------|---------|
| 1 | 16x16 | 新手村 | 默认解锁 |
| 2 | 24x24 | 繁荣小镇 | 人口≥50, 金币≥5000, 稳定度≥60, 建筑≥10, 完成任务 quest_001, quest_002 |
| 3 | 32x32 | 中型城市 | 人口≥150, 金币≥15000, 稳定度≥70, 建筑≥25, 完成任务 quest_003-005 |
| 4 | 40x40 | 大型都市 | 人口≥300, 金币≥30000, 稳定度≥75, 建筑≥50, 完成任务 quest_006-009 |
| 5 | 48x48 | 超级城市 | 人口≥500, 金币≥50000, 稳定度≥80, 建筑≥80, 完成任务 quest_010-012 |

#### 1.2 关卡管理器 (`src/js/utils/level-system.js`)

**核心功能**：
- 定期检测是否可以解锁下一关（每 5 秒）
- 检查城市指标和任务完成情况
- 自动解锁关卡并显示解锁弹窗
- 支持手动切换到已解锁的关卡
- 扩展地图大小

**关键方法**：
```javascript
checkNextLevelUnlock()  // 检查下一关解锁条件
unlockLevel(level, config)  // 解锁关卡
switchToLevel(level)  // 切换到指定关卡
expandMapToLevel(newSize)  // 扩展地图
```

### 2. 任务系统 (Quest System)

#### 2.1 任务配置 (`src/constants/quest-config.js`)

定义了多种任务类型：

- **建造任务** (`build_count`): 建造指定数量的建筑
- **资源任务** (`total_earned`): 累计获得指定数量的金币
- **指标任务** (`metric_reach`): 达到指定的城市指标（人口、电力等）
- **升级任务** (`upgrade_count`): 升级指定数量的建筑
- **特殊任务** (`build_multiple`, `build_all_types`): 建造多种建筑或所有类型

#### 2.2 任务管理器 (`src/js/utils/quest-system.js`)

**核心功能**：
- 监听游戏事件（建筑建造、升级、金币变化等）
- 实时更新任务进度
- 检测任务完成并发放奖励
- 同步任务状态到 Pinia

**关键方法**：
```javascript
updateQuestProgress(eventType, data)  // 更新任务进度
checkQuestCompletion(questId)  // 检查任务是否完成
completeQuest(questId)  // 完成任务并发放奖励
checkMetricQuests()  // 定期检查指标类任务
```

---

## 🎮 游戏流程

### 玩家游戏流程

```
1. 开始游戏 → 关卡1 (16x16)
   ↓
2. 建造建筑、完成任务
   ↓
3. 满足解锁条件 → 关卡2解锁弹窗
   ↓
4. 选择"立即切换" → 地图扩展至 24x24
   ↓
5. 继续游戏 → 重复步骤 2-4
```

### 系统检测流程

```
每 5 秒执行一次：
1. 检查当前关卡的下一个关卡
2. 验证城市指标（人口、金币、稳定度、建筑数）
3. 验证任务完成情况
4. 如果全部满足 → 解锁关卡并显示弹窗
```

---

## 📊 状态管理

### Pinia Store 扩展 (`src/stores/useGameState.js`)

新增状态：

```javascript
// 关卡系统状态
currentLevel: 1,              // 当前关卡
unlockedLevels: [1],          // 已解锁的关卡列表
totalEarnedCredits: 0,        // 累计获得的金币

// 任务系统状态
completedQuests: [],          // 已完成的任务ID列表
questProgress: {},            // 任务进度
showQuestPanel: false,        // 是否显示任务面板
showLevelUnlockModal: false,  // 是否显示关卡解锁弹窗
pendingLevelUnlock: null,     // 待解锁的关卡信息
```

新增方法：

```javascript
// 关卡系统
setCurrentLevel(level)
unlockLevel(level)
isLevelUnlocked(level)
expandMap(newSize)

// 任务系统
completeQuest(questId)
isQuestCompleted(questId)
updateQuestProgress(questId, progress)
setShowQuestPanel(show)
setShowLevelUnlockModal(show)
```

---

## 🖼️ UI 组件

### 1. 任务面板 (`src/components/QuestPanel.vue`)

**功能**：
- 显示当前关卡的所有任务
- 实时显示任务进度（进度条）
- 标记已完成的任务
- 显示任务奖励

**触发方式**：点击顶部栏的"📋 任务"按钮

### 2. 关卡解锁弹窗 (`src/components/LevelUnlockModal.vue`)

**功能**：
- 显示解锁的关卡信息
- 显示地图大小和奖励
- 提供"立即切换"和"稍后切换"选项

**触发方式**：自动弹出（当关卡解锁时）

---

## 🔧 技术实现细节

### 1. 地图动态扩展

**实现位置**：`src/js/components/tiles/city.js`

- 监听 `map:expanded` 事件
- 从 `gameState.citySize` 读取最新地图大小
- 重建地皮网格，保留原有建筑数据

### 2. 事件系统集成

**事件总线**：`src/js/utils/event-bus.js`

关键事件：
- `building:placed` - 建筑建造时触发
- `building:upgraded` - 建筑升级时触发
- `credits:changed` - 金币变化时触发
- `quest:completed` - 任务完成时触发
- `level:unlocked` - 关卡解锁时触发
- `map:expanded` - 地图扩展时触发

### 3. 系统初始化

**位置**：`src/js/experience.js`

```javascript
// 初始化关卡系统和任务系统
this.levelSystem = new LevelSystem()
this.questSystem = new QuestSystem()

// 启动关卡检测
this.levelSystem.start()
```

---

## 📝 任务配置示例

### 关卡1任务

```javascript
{
  id: 'quest_001',
  level: 1,
  type: 'build',
  name: { zh: '初来乍到', en: 'First Steps' },
  description: { zh: '建造你的第一座住宅建筑', en: 'Build your first residential building' },
  condition: {
    type: 'build_count',
    buildingType: 'house',
    count: 1,
  },
  rewards: { credits: 500 },
}
```

### 关卡2任务

```javascript
{
  id: 'quest_003',
  level: 2,
  type: 'build',
  name: { zh: '商业起步', en: 'Commercial Start' },
  description: { zh: '建造 3 座商业建筑', en: 'Build 3 commercial buildings' },
  condition: {
    type: 'build_count',
    buildingType: 'shop',
    count: 3,
  },
  rewards: { credits: 1500 },
}
```

---

## 🎨 用户体验优化

1. **自动检测**：系统每 5 秒自动检测解锁条件，无需玩家手动操作
2. **即时反馈**：任务进度实时更新，进度条可视化
3. **奖励提示**：任务完成和关卡解锁都有明确的奖励提示
4. **灵活切换**：关卡解锁后可以选择立即切换或稍后切换

---

## 🚀 未来扩展

1. **更多关卡**：可以轻松添加更多关卡（56x56, 64x64 等）
2. **任务类型扩展**：可以添加更复杂的任务类型（如"连续 X 天稳定度保持 Y"）
3. **成就系统**：基于任务完成情况解锁成就
4. **排行榜**：按关卡进度和任务完成情况排名

---

## 📌 注意事项

1. **数据持久化**：所有关卡和任务状态都会自动保存到 localStorage
2. **性能考虑**：地图扩展时只扩展 metadata 数组，原有建筑数据保留
3. **事件同步**：确保建筑建造和升级事件正确触发，任务系统才能正常工作

---

## ✅ 完成清单

- [x] 关卡配置系统
- [x] 任务配置系统
- [x] 关卡管理器
- [x] 任务管理器
- [x] Pinia 状态扩展
- [x] 任务面板 UI
- [x] 关卡解锁弹窗 UI
- [x] 地图动态扩展
- [x] 事件系统集成
- [x] 系统初始化

---

**文档版本**: 1.0  
**最后更新**: 2025-01-XX  
**作者**: AI Assistant

