<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLB æ¨¡å‹ç”Ÿæˆå™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }
    
    select, input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 10px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      display: none;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }
    
    .info-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }
    
    .info-box strong {
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ—ï¸ GLB æ¨¡å‹ç”Ÿæˆå™¨</h1>
    <p class="subtitle">ä½¿ç”¨ Three.js ç”Ÿæˆç®€å•çš„å»ºç­‘æ¨¡å‹</p>
    
    <form id="modelForm">
      <div class="form-group">
        <label for="buildingType">å»ºç­‘ç±»å‹ï¼š</label>
        <select id="buildingType" required>
          <option value="house">æˆ¿å±‹ (House)</option>
          <option value="house2">æˆ¿å±‹2 (House 2)</option>
          <option value="shop">å•†åº— (Shop)</option>
          <option value="office">åŠå…¬æ¥¼ (Office)</option>
          <option value="factory">å·¥å‚ (Factory)</option>
          <option value="hospital">åŒ»é™¢ (Hospital)</option>
          <option value="police">è­¦å¯Ÿå±€ (Police)</option>
          <option value="fire_station">æ¶ˆé˜²ç«™ (Fire Station)</option>
          <option value="park">å…¬å›­ (Park)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="level">ç­‰çº§ï¼š</label>
        <select id="level" required>
          <option value="level1">ç­‰çº§ 1</option>
          <option value="level2">ç­‰çº§ 2</option>
          <option value="level3">ç­‰çº§ 3</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="filename">æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰ï¼š</label>
        <input type="text" id="filename" placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ">
      </div>
      
      <button type="submit" id="generateBtn">ç”Ÿæˆå¹¶ä¸‹è½½ GLB æ¨¡å‹</button>
    </form>
    
    <div id="status" class="status"></div>
    
    <div class="info-box">
      <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
      â€¢ é€‰æ‹©å»ºç­‘ç±»å‹å’Œç­‰çº§åç‚¹å‡»ç”ŸæˆæŒ‰é’®<br>
      â€¢ ç”Ÿæˆçš„ GLB æ–‡ä»¶ä¼šè‡ªåŠ¨ä¸‹è½½<br>
      â€¢ å°†ä¸‹è½½çš„æ–‡ä»¶æ”¾å…¥ <code>public/models/</code> ç›®å½•<br>
      â€¢ åœ¨ <code>src/js/sources.js</code> ä¸­æ³¨å†Œæ–°æ¨¡å‹<br>
      <br>
      <strong>æ³¨æ„ï¼š</strong>è¿™æ˜¯ç®€åŒ–ç‰ˆæ¨¡å‹ç”Ÿæˆå™¨ï¼Œç”Ÿæˆçš„æ¨¡å‹è¾ƒä¸ºåŸºç¡€ã€‚å¦‚éœ€å¤æ‚æ¨¡å‹ï¼Œå»ºè®®ä½¿ç”¨ Blender ç­‰ä¸“ä¸š 3D è½¯ä»¶ã€‚
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.172.0/build/three.module.js'
    import { GLTFExporter } from 'https://cdn.jsdelivr.net/npm/three@0.172.0/examples/jsm/exporters/GLTFExporter.js'

    // å¤åˆ¶æ¨¡å‹ç”Ÿæˆé€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
    function createBuildingGeometry(buildingType, level) {
      const group = new THREE.Group()
      const baseSize = 1
      const heightMultiplier = getHeightMultiplier(buildingType, level)
      const height = baseSize * heightMultiplier

      const geometry = new THREE.BoxGeometry(baseSize, height, baseSize)
      const color = getBuildingColor(buildingType, level)
      const material = new THREE.MeshStandardMaterial({
        color: color,
        metalness: 0.3,
        roughness: 0.7,
      })

      const mainBody = new THREE.Mesh(geometry, material)
      mainBody.position.y = height / 2
      mainBody.castShadow = true
      mainBody.receiveShadow = true
      group.add(mainBody)

      // æ·»åŠ ç»†èŠ‚ï¼ˆç®€åŒ–ç‰ˆï¼‰
      if (buildingType === 'house' || buildingType === 'house2') {
        const roofGeometry = new THREE.ConeGeometry(0.7, 0.3, 4)
        const roofMaterial = new THREE.MeshStandardMaterial({ color: '#8B4513' })
        const roof = new THREE.Mesh(roofGeometry, roofMaterial)
        roof.rotation.y = Math.PI / 4
        roof.position.y = height + 0.15
        group.add(roof)
      }

      return group
    }

    function getHeightMultiplier(buildingType, level) {
      const levelNum = parseInt(level.replace('level', '')) || 1
      const baseHeights = {
        house: 1.2, house2: 1.2, shop: 1.5, office: 2.0,
        factory: 1.8, hospital: 2.5, police: 2.0,
        fire_station: 2.2, park: 0.3,
      }
      const baseHeight = baseHeights[buildingType] || 1.5
      return baseHeight + (levelNum - 1) * 0.3
    }

    function getBuildingColor(buildingType, level) {
      const levelNum = parseInt(level.replace('level', '')) || 1
      const colorMap = {
        house: ['#E8D5B7', '#D4C4A8', '#C0B399'],
        house2: ['#B8D4E3', '#A8C4D3', '#98B4C3'],
        shop: ['#FFD700', '#FFC125', '#FFB347'],
        office: ['#C0C0C0', '#A8A8A8', '#909090'],
        factory: ['#8B4513', '#A0522D', '#CD853F'],
        hospital: ['#FFFFFF', '#F0F0F0', '#E0E0E0'],
        police: ['#4169E1', '#1E90FF', '#00BFFF'],
        fire_station: ['#FF4500', '#FF6347', '#FF7F50'],
        park: ['#228B22', '#32CD32', '#3CB371'],
      }
      const colors = colorMap[buildingType] || ['#CCCCCC']
      return colors[Math.min(levelNum - 1, colors.length - 1)]
    }

    async function generateModel(buildingType, level, filename) {
      const scene = new THREE.Scene()
      const model = createBuildingGeometry(buildingType, level)
      scene.add(model)

      const exporter = new GLTFExporter()
      
      return new Promise((resolve, reject) => {
        exporter.parse(
          scene,
          (result) => {
            const blob = new Blob([result], { type: 'application/octet-stream' })
            resolve(blob)
          },
          (error) => {
            reject(error)
          },
          {
            binary: true,
            trs: false,
            onlyVisible: true,
            truncateDrawRange: true,
            embedImages: true,
          }
        )
      })
    }

    function downloadGLB(blob, filename) {
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = filename
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      URL.revokeObjectURL(url)
    }

    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('status')
      statusEl.textContent = message
      statusEl.className = `status ${type}`
      setTimeout(() => {
        statusEl.className = 'status'
      }, 5000)
    }

    document.getElementById('modelForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      
      const buildingType = document.getElementById('buildingType').value
      const level = document.getElementById('level').value
      const customFilename = document.getElementById('filename').value.trim()
      const filename = customFilename || `${buildingType}_${level}.glb`
      
      const btn = document.getElementById('generateBtn')
      btn.disabled = true
      btn.textContent = 'ç”Ÿæˆä¸­...'
      
      try {
        showStatus('æ­£åœ¨ç”Ÿæˆæ¨¡å‹ï¼Œè¯·ç¨å€™...', 'info')
        const blob = await generateModel(buildingType, level, filename)
        downloadGLB(blob, filename)
        showStatus(`âœ… æ¨¡å‹å·²ç”Ÿæˆå¹¶ä¸‹è½½: ${filename}`, 'success')
      } catch (error) {
        console.error('ç”Ÿæˆå¤±è´¥:', error)
        showStatus(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error')
      } finally {
        btn.disabled = false
        btn.textContent = 'ç”Ÿæˆå¹¶ä¸‹è½½ GLB æ¨¡å‹'
      }
    })
  </script>
</body>
</html>


